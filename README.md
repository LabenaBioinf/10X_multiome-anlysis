# 10X_multiome anlysis (10x Genomics Multiome ATAC+GEX)

Bioinformatics pipeline for processing 10x Genomics Multiome ATAC+GEX results generated using Cell Ranger ARC software.

## SC_GEX-ATAC.R
Main script to run per-patient and integrated pseudo-bulk (across all patients) flare vs. remission analyses.<br>
It expects `atac_peaks.bed`, `per_barcode_metrics.csv`, `atac_fragments.tsv.gz`, and `filtered_feature_bc_matrix.h5` generated using [Cell Ranger ARC](https://support.10xgenomics.com/single-cell-multiome-atac-gex/software/overview/welcome) software as input files.<br>
The script sources several other R scripts that rely on packages such as [Seurat](https://satijalab.org/seurat/), [Signac](https://stuartlab.org/signac/), [scDblFinder](https://github.com/plger/scDblFinder), [Harmony](https://github.com/immunogenomics/harmony), [fgsea](https://github.com/alserglab/fgsea), and [FigR](https://github.com/buenrostrolab/FigR) to perform the following steps:

#### preprocess_and_QC.R
* set up Seurat objects
* run QC check and filters out low-quality cells

#### normalize.R
* normalize data

#### batch_effect.R
* preform batch correction using Harmony

#### annotate_and_integrate.R
* perform cell type annotation
* integrate data from different conditions

### Wilcoxon_test.R
* calculate Wilcoxon test to obtain differences in cell proportions

#### DE.R
* identify differentially expressed genes in each cell type across conditions

#### GSEA.R
* run gene set enrichment analysis uding fgsea and irGSEA

#### FigR_networks_Control.R
* run regulatory network and DORC analysis using cisTopic and FigR for Remission state

#### FigR_networks_MISC.R
* run regulatory network and DORC analysis using cisTopic and FigR for state in MISC flare

#### keep_only_flare_network_correlations.R
* retaine only significant gene-peak correlations exclusively present during MIS-C flare


## scCODA.py
Script to run compositional analysis of single-cell data using [scCODA](https://sccoda.readthedocs.io/en/latest/getting_started.html) package.<br>
Uses *_cell_type_count.txt file generated by SC_GEX-ATAC.R as input.


## Singularity.def

Singularity containerization simplifies management of package dependencies across different machines and facilitates deployment on High-Performance Computing (HPC) environments.

### Create Singularity Container

**Definition File**: The definition (recipe) file (`Singularity.def`) instructs the installation of necessary system packages, R version 4.1.3, and project-specific R packages.

**Build Singularity Image**:
```bash
sudo singularity build [image_name.sif] Singularity.def
```

### Option 1: Run Singularity Container Locally

```bash
singularity exec --bind /local/data/SC_RNA_seq_results:/home/results --bind /local/data/resources:/home/resources --bind /local/data/scripts:/home/scripts [image_name.sif] Rscript SC_GEX-ATAC.R
```

`singularity exec` runs `Rscript SC_GEX-ATAC.R` command within a `[image_name.sif]` container. The three `--bind` arguments map host directories to the container directories. The first one binds the path to the input data, the second binds the path to the resources, and the third one binds the path to directory containing needed R scripts. These should be changed depending on the location where they reside, or you can bind other paths you might need.

### Option 2: Run Singularity Container on HPC

Create a submission script for your job scheduler specifiying the needed resources and the command to execute. For instance for SLURM, the submission script contains a header (#SBATCH ...) specifying time limit, memory, etc. You can change these values depending on your needs. E.g. file `scell.sh`:

```bash
#!/bin/bash

#SBATCH --time=2-00:00:00
#SBATCH --mem=250G
#SBATCH --job-name=SCell
#SBATCH --nodes=1
#SBATCH --cpus-per-task=8
#SBATCH --partition=largemem
#SBATCH --output=scell.%j.out


singularity exec --bind /hpc/data/SC_RNA_seq_results:/home/results --bind /hpc/data/resources:/home/resources --bind /hpc/data/scripts:/home/scripts SCell.sif Rscript SC_GEX-ATAC.R
```

Run the command bellow to submit a job:

```bash
sbatch scell.sh